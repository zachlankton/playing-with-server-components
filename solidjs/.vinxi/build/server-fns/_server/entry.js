import{fromJSON as D,crossSerializeStream as B,getCrossReferenceHeader as X}from"seroval";import{CustomEventPlugin as H,DOMExceptionPlugin as E,EventPlugin as P,FormDataPlugin as A,HeadersPlugin as C,ReadableStreamPlugin as x,RequestPlugin as k,ResponsePlugin as O,URLSearchParamsPlugin as F,URLPlugin as _}from"seroval-plugins/web";import{lazy as z,createComponent as J,createSignal as G,sharedConfig as I}from"solid-js";import{ssrElement as m,escape as S,mergeProps as K,ssr as L,isServer as V,ssrHydrationKey as Q,renderToStringAsync as Y}from"solid-js/web";import{provideRequestEvent as U}from"solid-js/web/storage";import{H3Event as b,setResponseStatus as Z,setHeader as ee,getRequestURL as te,getRequestIP as re,getResponseStatus as ne,getResponseStatusText as se,getCookie as oe,setCookie as ae,getResponseHeaders as ie,getResponseHeader as ue,setResponseHeader as ce,appendResponseHeader as le,getRequestWebStream as pe,removeResponseHeader as fe,eventHandler as de}from"h3";import{getContext as he}from"unctx";import{AsyncLocalStorage as ge}from"node:async_hooks";import{createRouter as me}from"radix3";import*as ye from"fs";function Re(e){let t;const r=j(e),n={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(r,{...n,body:e.node.req.body}):new Request(r,{...n,get body(){return t||(t=Pe(e),t)}})}function Se(e){return e.web??={request:Re(e),url:j(e)},e.web.request}function be(){return xe()}const h=Symbol("$HTTPEvent");function we(e){return typeof e=="object"&&(e instanceof b||e?.[h]instanceof b||e?.__is_event__===!0)}function u(e){return function(...t){let r=t[0];if(we(r))t[0]=r instanceof b||r.__is_event__?r:r[h];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(r=be(),!r)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(r)}return e(...t)}}const j=u(te),$e=u(re),w=u(Z),v=u(ne),ve=u(se),g=u(ie),T=u(ue),Te=u(ce),qe=u(le),He=u(oe),Ee=u(ae),M=u(ee),Pe=u(pe),Ae=u(fe);function Ce(){return he("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ge})}function xe(){return Ce().use().event}const y="Invariant Violation",{setPrototypeOf:ke=function(e,t){return e.__proto__=t,e}}=Object;class $ extends Error{framesToPop=1;name=y;constructor(t=y){super(typeof t=="number"?`${y}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),ke(this,$.prototype)}}function Oe(e,t){if(!e)throw new $(t)}const R=Symbol("fetchEvent");function Fe(e){return{request:Se(e),response:Ue(e),clientAddress:$e(e),locals:{},nativeEvent:e,[h]:e}}function _e(e){return{...e,[h]:e[h]}}function Ie(e){if(!e[R]){const t=Fe(e);e[R]=t}return e[R]}function q(e,t){for(const[r,n]of t.entries())M(e,r,n)}class Le{constructor(t){this.event=t}get(t){const r=T(this.event,t);return Array.isArray(r)?r.join(", "):r}has(t){return this.get(t)!==void 0}set(t,r){return Te(this.event,t,r)}delete(t){return Ae(this.event,t)}append(t,r){qe(this.event,t,r)}getSetCookie(){const t=T(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(g(this.event)).forEach(([r,n])=>t(Array.isArray(n)?n.join(", "):n,r,this))}entries(){return Object.entries(g(this.event)).map(([t,r])=>[t,Array.isArray(r)?r.join(", "):r])[Symbol.iterator]()}keys(){return Object.keys(g(this.event))[Symbol.iterator]()}values(){return Object.values(g(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Ue(e){return{get status(){return v(e)},set status(t){w(e,t)},get statusText(){return ve(e)},set statusText(t){w(e,v(),t)},headers:new Le(e)}}function je(e){e.forEach(t=>{if(!t.attrs.href)return;let r=document.head.querySelector(`link[href="${t.attrs.href}"]`);r||(r=document.createElement("link"),r.setAttribute("rel","preload"),r.setAttribute("as","style"),r.setAttribute("href",t.attrs.href),document.head.appendChild(r))})}var Me=" ";const Ne={style:e=>m("style",e.attrs,()=>S(e.children),!0),link:e=>m("link",e.attrs,void 0,!0),script:e=>e.attrs.src?m("script",K(()=>e.attrs,{get id(){return e.key}}),()=>L(Me),!0):null};function We(e){let{tag:t,attrs:{key:r,...n}={key:void 0},children:o}=e;return Ne[t]({attrs:n,key:r,children:o})}function De(e,t,r,n="default"){return z(async()=>{{const c=(await e.import())[n],i=(await t.inputs?.[e.src].assets()).filter(p=>p.tag==="style"||p.attrs.rel==="stylesheet");return typeof window<"u"&&je(i),{default:p=>[...i.map(l=>We(l)),J(c,p)]}}})}const N=[],Be=Xe(N.filter(e=>e.$component));function Xe(e){function t(r,n,o,c){const a=Object.values(r).find(i=>o.startsWith(i.id+"/"));return a?(t(a.children||(a.children=[]),n,o.slice(a.id.length)),r):(r.push({...n,id:o,path:o.replace(/\/\([^)/]+\)/g,"")}),r)}return e.sort((r,n)=>r.path.length-n.path.length).reduce((r,n)=>t(r,n,n.path,n.path),[])}function ze(e){return e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}me({routes:N.reduce((e,t)=>{if(!ze(t))return e;let r=t.path.replace(/\(.*\)\/?/g,"").replace(/\*([^/]*)/g,(n,o)=>`**:${o}`);if(/:[^/]*\?/g.test(r))throw new Error(`Optional parameters are not supported in API routes: ${r}`);if(e[r])throw new Error(`Duplicate API routes for "${r}" found at "${e[r].route.path}" and "${t.path}"`);return e[r]={route:t},e},{})});function Je(){function e(r){return{...r,...r.$$route?r.$$route.require().route:void 0,info:{...r.$$route?r.$$route.require().route.info:{},filesystem:!0},component:De(r.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:r.children?r.children.map(e):void 0}}return Be.map(e)}function Ge(e){const t=He(e,"flash");if(!t)return;let r=JSON.parse(t);if(!r||!r.result)return[];const n=[...r.input.slice(0,-1),new Map(r.input[r.input.length-1])];return Ee(e,"flash","",{maxAge:0}),{url:r.url,result:r.error?new Error(r.result):r.result,input:n}}async function Ke(e){const t=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await t.json(),assets:[...await t.inputs[t.handler].assets()],router:{submission:Ge(e)},routes:Je(),$islands:new Set})}var Ve=["<main","><h1>Hello world!</h1><p>",'</p><button class="increment">Clicks: <!--$-->','<!--/--></button><p>Visit <a href="https://start.solidjs.com" target="_blank">start.solidjs.com</a> to learn how to build SolidStart apps.</p></main>'];function Qe(){let e="Default value";const[t,r]=G(0);return V&&(e=ye.readFileSync("/tmp/test.txt","utf8")),L(Ve,Q(),S(e),S(t()))}function Ye(e){const r=e.length.toString(16),n="00000000".substring(0,8-r.length)+r;return new TextEncoder().encode(`;0x${n};${e}`)}function Ze(e,t){return new ReadableStream({start(r){B(t,{scopeId:e,plugins:[H,E,P,A,C,x,k,O,F,_],onSerialize(n,o){r.enqueue(Ye(o?`(${X(e)},${n})`:n))},onDone(){r.close()},onError(n){r.error(n)}})}})}async function et(e){const t=Ie(e),r=t.request,n=r.headers.get("X-Server-Id"),o=r.headers.get("X-Server-Instance"),c=r.headers.has("X-Single-Flight"),a=new URL(r.url);let i,d;if(n)Oe(typeof n=="string","Invalid server function"),[i,d]=n.split("#");else if(i=a.searchParams.get("id"),d=a.searchParams.get("name"),!i||!d)throw new Error("Invalid request");const p=(await globalThis.MANIFEST["server-fns"].chunks[i].import())[d];let l=[];if(!o||e.method==="GET"){const s=a.searchParams.get("args");s&&JSON.parse(s).forEach(f=>l.push(f))}if(e.method==="POST"){const s=r.headers.get("content-type");if(s.startsWith("multipart/form-data")||s.startsWith("application/x-www-form-urlencoded"))l.push(await new Request(r,{...r,body:e.node.req.body}).formData());else{const f=new Request(r,{...r,body:e.node.req.body});l=D(await f.json(),{plugins:[H,E,P,A,C,x,k,O,F,_]})}}try{let s=await U(t,async()=>(I.context={event:t},p(...l)));if(c&&o&&(s=await tt(t,s)),s instanceof Response&&o&&(s.headers&&q(e,s.headers),s.customBody?s=await s.customBody():s.body==null&&(s=null)),!o){const f=s instanceof Error,W=new URL(r.headers.get("referer"));return new Response(null,{status:302,headers:{Location:W.toString(),...s?{"Set-Cookie":`flash=${JSON.stringify({url:a.pathname+encodeURIComponent(a.search),result:f?s.message:s,error:f,input:[...l.slice(0,-1),[...l[l.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return M(e,"content-type","text/javascript"),Ze(o,s)}catch(s){return s instanceof Response&&(s.status===302&&!o&&w(e,302),s.headers&&q(e,s.headers),s.customBody?s=await s.customBody():s.body==null&&(s=null)),s}}async function tt(e,t){let r,n=new URL(e.request.headers.get("referer")).toString();t instanceof Response&&(t.headers.has("X-Revalidate")&&(r=t.headers.get("X-Revalidate").split(",")),t.headers.has("Location")&&(n=new URL(t.headers.get("Location"),new URL(e.request.url).origin+"").toString()));const o=_e(e);return o.request=new Request(n),await U(o,async()=>{await Ke(o),o.router.dataOnly=r||!0,o.router.previousUrl=e.request.headers.get("referer"),(async()=>{try{await Y(()=>{I.context={event:o},Qe()})}catch(i){console.log(i)}})();const c=o.router.data;if(!c)return t;let a=!1;for(const i in c)c[i]===void 0?delete c[i]:a=!0;return a&&(t instanceof Response||(c._$value=t,t=new Response(null,{status:200})),t.customBody=()=>c,t.headers.set("X-Single-Flight","true")),t})}const pt=de(et);export{pt as default};
