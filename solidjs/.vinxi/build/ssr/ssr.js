import{isServer as k,ssr as p,ssrHydrationKey as y,escape as l,getRequestEvent as x,createComponent as c,ssrElement as R,mergeProps as F,useAssets as N,NoHydration as P,HydrationScript as j,ssrAttribute as O,Hydration as B,renderToStream as W}from"solid-js/web";import{createSignal as U,onCleanup as D,ErrorBoundary as z,lazy as G,createComponent as J,sharedConfig as E}from"solid-js";import*as K from"fs";import{provideRequestEvent as V}from"solid-js/web/storage";import{H3Event as S,setResponseStatus as Y,sendRedirect as Q,getCookie as X,setCookie as Z,setHeader as ee,getRequestURL as te,getRequestIP as ne,getResponseStatus as re,getResponseStatusText as se,getResponseHeaders as oe,getResponseHeader as ae,setResponseHeader as ie,appendResponseHeader as ce,getRequestWebStream as ue,removeResponseHeader as le,eventHandler as pe}from"h3";import{getContext as de}from"unctx";import{AsyncLocalStorage as he}from"node:async_hooks";import{createRouter as fe}from"radix3";var me=["<main","><h1>Hello world!</h1><p>",'</p><button class="increment">Clicks: <!--$-->','<!--/--></button><p>Visit <a href="https://start.solidjs.com" target="_blank">start.solidjs.com</a> to learn how to build SolidStart apps.</p></main>'];function ge(){let e="Default value";const[t,n]=U(0);return k&&(e=K.readFileSync("/tmp/test.txt","utf8")),p(me,y(),l(e),l(t()))}function ye(e){if(k){const t=x();t.response.status=e.code,t.response.statusText=e.text,D(()=>!t.nativeEvent.handled&&(t.response.status=200))}return null}function Re(e){return c(z,{get fallback(){return c(ye,{code:500})},get children(){return e.children}})}var $e=" ";const Se={style:e=>R("style",e.attrs,()=>l(e.children),!0),link:e=>R("link",e.attrs,void 0,!0),script:e=>e.attrs.src?R("script",F(()=>e.attrs,{get id(){return e.key}}),()=>p($e),!0):null};function b(e){let{tag:t,attrs:{key:n,...r}={key:void 0},children:s}=e;return Se[t]({attrs:r,key:n,children:s})}var be=["<script",">","<\/script>"],ve=["<script",' type="module" async',"><\/script>"];const Te=p("<!DOCTYPE html>");function _(e,t,n=[]){for(let r=0;r<t.length;r++){const s=t[r];if(s.path!==e[0].path)continue;let o=[...n,s];if(s.children){const a=e.slice(1);if(a.length===0||(o=_(a,s.children,o),!o))continue}return o}}function we(e){const t=x();let n=[];return Promise.resolve().then(async()=>{if(t.router&&t.router.matches){const r=[...t.router.matches];for(;r.length&&(!r[0].info||!r[0].info.filesystem);)r.shift();const s=r.length&&_(r,t.routes);if(s)for(let o=0;o<s.length;o++){const a=s[o],m=await globalThis.MANIFEST.client.inputs[a.$component.src].assets();n.push.apply(n,m)}else console.warn("No route matched for preloading js assets")}n=[...new Map(n.map(r=>[r.attrs.key,r])).values()].filter(r=>r.attrs.rel==="modulepreload"&&!t.assets.find(s=>s.attrs.key===r.attrs.key))}),N(()=>n.length?n.map(r=>b(r)):void 0),c(P,{get children(){return[Te,c(e.document,{get assets(){return[c(j,{}),t.assets.map(r=>b(r))]},get scripts(){return[p(be,y(),`window.manifest = ${JSON.stringify(t.manifest)}`),p(ve,y(),O("src",l(globalThis.MANIFEST.client.inputs[globalThis.MANIFEST.client.handler].output.path,!0),!1))]},get children(){return c(B,{get children(){return c(Re,{get children(){return c(ge,{})}})}})}})]}})}function Ee(e){let t;const n=I(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=Fe(e),t)}})}function Ae(e){return e.web??={request:Ee(e),url:I(e)},e.web.request}function Ce(){return Oe()}const T=Symbol("$HTTPEvent");function He(e){return typeof e=="object"&&(e instanceof S||e?.[T]instanceof S||e?.__is_event__===!0)}function i(e){return function(...t){let n=t[0];if(He(n))t[0]=n instanceof S||n.__is_event__?n:n[T];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=Ce(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const I=i(te),qe=i(ne),v=i(Y),A=i(re),ke=i(se),g=i(oe),C=i(ae),xe=i(ie),Pe=i(ce),_e=i(Q),Ie=i(X),Le=i(Z),Me=i(ee),Fe=i(ue),Ne=i(le);function je(){return de("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:he})}function Oe(){return je().use().event}const L=[],Be=We(L.filter(e=>e.$component));function We(e){function t(n,r,s,o){const a=Object.values(n).find(u=>s.startsWith(u.id+"/"));return a?(t(a.children||(a.children=[]),r,s.slice(a.id.length)),n):(n.push({...r,id:s,path:s.replace(/\/\([^)/]+\)/g,"")}),n)}return e.sort((n,r)=>n.path.length-r.path.length).reduce((n,r)=>t(n,r,r.path,r.path),[])}function Ue(e,t){const n=ze.lookup(e);if(n){const r=n.route[`$${t}`];return r===void 0?void 0:{handler:r,params:n.params}}}function De(e){return e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}const ze=fe({routes:L.reduce((e,t)=>{if(!De(t))return e;let n=t.path.replace(/\(.*\)\/?/g,"").replace(/\*([^/]*)/g,(r,s)=>`**:${s}`);if(/:[^/]*\?/g.test(n))throw new Error(`Optional parameters are not supported in API routes: ${n}`);if(e[n])throw new Error(`Duplicate API routes for "${n}" found at "${e[n].route.path}" and "${t.path}"`);return e[n]={route:t},e},{})}),$=Symbol("fetchEvent");function Ge(e){return{request:Ae(e),response:Ve(e),clientAddress:qe(e),locals:{},nativeEvent:e,[T]:e}}function Je(e){if(!e[$]){const t=Ge(e);e[$]=t}return e[$]}class Ke{constructor(t){this.event=t}get(t){const n=C(this.event,t);return Array.isArray(n)?n.join(", "):n}has(t){return this.get(t)!==void 0}set(t,n){return xe(this.event,t,n)}delete(t){return Ne(this.event,t)}append(t,n){Pe(this.event,t,n)}getSetCookie(){const t=C(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(g(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries(g(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(g(this.event))[Symbol.iterator]()}values(){return Object.values(g(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Ve(e){return{get status(){return A(e)},set status(t){v(e,t)},get statusText(){return ke(e)},set statusText(t){v(e,A(),t)},headers:new Ke(e)}}function Ye(e){e.forEach(t=>{if(!t.attrs.href)return;let n=document.head.querySelector(`link[href="${t.attrs.href}"]`);n||(n=document.createElement("link"),n.setAttribute("rel","preload"),n.setAttribute("as","style"),n.setAttribute("href",t.attrs.href),document.head.appendChild(n))})}function Qe(e,t,n,r="default"){return G(async()=>{{const o=(await e.import())[r],u=(await t.inputs?.[e.src].assets()).filter(d=>d.tag==="style"||d.attrs.rel==="stylesheet");return typeof window<"u"&&Ye(u),{default:d=>[...u.map(h=>b(h)),J(o,d)]}}})}function Xe(){function e(n){return{...n,...n.$$route?n.$$route.require().route:void 0,info:{...n.$$route?n.$$route.require().route.info:{},filesystem:!0},component:Qe(n.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:n.children?n.children.map(e):void 0}}return Be.map(e)}function Ze(e){const t=Ie(e,"flash");if(!t)return;let n=JSON.parse(t);if(!n||!n.result)return[];const r=[...n.input.slice(0,-1),new Map(n.input[n.input.length-1])];return Le(e,"flash","",{maxAge:0}),{url:n.url,result:n.error?new Error(n.result):n.result,input:r}}async function M(e){const t=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await t.json(),assets:[...await t.inputs[t.handler].assets()],router:{submission:Ze(e)},routes:Xe(),$islands:new Set})}function et(e,t={}){return pe({onRequest:t.onRequest,onBeforeResponse:t.onBeforeResponse,handler:n=>{const r=Je(n);return V(r,async()=>{const s=Ue(new URL(r.request.url).pathname,r.request.method);if(s){const f=(await s.handler.import())[r.request.method];r.params=s.params,E.context={event:r};const w=await f(r);if(w!==void 0)return w;if(r.request.method!=="GET")throw new Error(`API handler for ${r.request.method} "${r.request.url}" did not return a response.`)}const o=await M(r);let a={...t};if(a.onCompleteAll){const h=a.onCompleteAll;a.onCompleteAll=f=>{q(o)(f),h(f)}}else a.onCompleteAll=q(o);if(a.onCompleteShell){const h=a.onCompleteShell;a.onCompleteShell=f=>{H(o,n)(),h(f)}}else a.onCompleteShell=H(o,n);const u=W(()=>(E.context.event=o,e(o)),a);if(o.response&&o.response.headers.get("Location"))return _e(r,o.response.headers.get("Location"));const{writable:m,readable:d}=new TransformStream;return u.pipeTo(m),d})}})}function H(e,t){return()=>{e.response&&e.response.headers.get("Location")&&(v(t,302),Me(t,"Location",e.response.headers.get("Location")))}}function q(e){return({write:t})=>{const n=e.response&&e.response.headers.get("Location");n&&t(`<script>window.location="${n}"<\/script>`)}}function tt(e,t={}){return et(e,{...t,createPageEvent:M})}var nt=['<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico">',"</head>"],rt=["<html",' lang="en">','<body><div id="app">',"</div><!--$-->","<!--/--></body></html>"];const pt=tt(()=>c(we,{document:({assets:e,children:t,scripts:n})=>p(rt,y(),c(P,{get children(){return p(nt,l(e))}}),l(t),l(n))}));export{pt as default};
